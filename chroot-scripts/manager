#!/bin/bash

. /chroot-scripts/ORDERED_SCRIPTS
scripts=(lfs-copy ${SCRIPTS[@]} lfs-cleanup lfs-setup-font lfs-setup-profile lfs-create-fstab)

set -e
set -u
set -x

. /chroot-scripts/automation-globals

if [ ! -z ${LFS_CHROOT_START_SCRIPT:-} ]; then
	for i in $(seq ${#scripts[@]}); do
		j=$((i-1))
		script=${scripts[$j]}
		if [ $script == $LFS_CHROOT_START_SCRIPT ]; then
			scripts=(${scripts[@]:$j})
			echo starting at script ${scripts[0]}
			break
		fi
	done
fi

KERNEL_LOCATION=/sources/linux-kernel/$(basename $(cat /chroot-scripts/PACKAGES | grep "^linux-kernel" | awk '{ print $2; }'))
modify_kernel_config() {
	pushd $KERNEL_LOCATION > /dev/null
	if [ ! -e lfs-config ]; then
		echo "LFS has not created the kernel config yet, update build order so the kernel config pre-req is met"
		exit 1
	else
		local program
		local modification
		for modification in $@; do
			config_argument=$(echo $modification | cut -d'=' -f 1)
			program="/${config_argument}=/ c $modification"
			sed -i "$program" lfs-config
		done

		make KCONFIG_CONFIG=lfs-config oldconfig
	fi
	popd
}

echo "script order is ${scripts[@]}"
pushd /sources
for script in ${scripts[@]}; do
	(
		. /chroot-scripts/$script
		if [ ! -z ${script##lfs-*} ]; then
			enter_package_source
			do_build
		fi
	)
done
